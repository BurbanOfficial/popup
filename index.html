<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Installer l'application</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f4f4f4;
    }
    /* Pop-up minimaliste et animé */
    #installPopup {
      position: fixed;
      bottom: -100px; /* caché initialement */
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.85);
      color: #fff;
      padding: 12px 20px;
      border-radius: 8px 8px 0 0;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.5);
      opacity: 0;
      transition: bottom 0.5s ease-out, opacity 0.5s ease-out;
      z-index: 9999;
      display: flex;
      align-items: center;
    }
    /* Classe pour afficher le pop-up */
    #installPopup.show {
      bottom: 20px;
      opacity: 1;
    }
    #installPopup span {
      font-size: 16px;
    }
    #installPopup button {
      background: #00bcd4;
      border: none;
      color: #fff;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 15px;
      font-size: 14px;
    }
    #installPopup button:hover {
      background: #007c8c;
    }
  </style>
</head>
<body>

  <!-- Contenu principal de la page -->
  <div style="padding: 20px;">
    <h1>Bienvenue sur notre site</h1>
    <p>Installez notre application pour un accès rapide directement depuis votre écran d'accueil.</p>
  </div>
  
  <!-- Pop-up d'installation -->
  <div id="installPopup">
    <span id="popupMessage">Installer l'application sur votre écran d'accueil</span>
    <button id="installButton">Installer</button>
  </div>
  
  <script>
    let deferredPrompt;
    const popup = document.getElementById('installPopup');
    const installButton = document.getElementById('installButton');

    // Détecte si l'appareil est mobile
    function isMobile() {
      return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    }

    // Mise à jour de l'affichage du pop-up selon le mode d'affichage
    function updatePopupBasedOnDisplayMode() {
      // Si l'application est lancée en mode standalone, on considère qu'elle est installée.
      if (window.matchMedia('(display-mode: standalone)').matches) {
        localStorage.setItem('pwaInstalled', 'true');
        popup.classList.remove('show');
      } else {
        // Si on est en mode navigateur, on vérifie le flag stocké.
        // S'il était marqué comme installé, on considère qu'il a été supprimé.
        if (localStorage.getItem('pwaInstalled')) {
          localStorage.removeItem('pwaInstalled');
        }
        // On affiche le pop-up si l'appareil est mobile
        if (isMobile()) {
          popup.classList.add('show');
        }
      }
    }

    // Ne rien faire sur desktop
    if (!isMobile()) {
      console.log("Pop-up désactivé sur desktop.");
    } else {
      // Écouter l'événement beforeinstallprompt pour les navigateurs compatibles (ex. Chrome sur Android)
      window.addEventListener('beforeinstallprompt', (e) => {
        // Empêche l'affichage automatique de la mini-infobulle
        e.preventDefault();
        deferredPrompt = e;
        // Afficher le pop-up après 3 secondes
        setTimeout(() => {
          popup.classList.add('show');
        }, 3000);
      });
    }

    // Au clic sur le bouton d'installation
    installButton.addEventListener('click', async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === 'accepted') {
          console.log('Installation acceptée.');
          localStorage.setItem('pwaInstalled', 'true');
          popup.classList.remove('show');
        } else {
          console.log('Installation refusée.');
        }
        deferredPrompt = null;
      } else {
        // Si aucune invite n'est disponible (cas d'iOS ou d'autres navigateurs)
        alert("Votre navigateur ne supporte pas l'installation automatique. Veuillez ajouter l'application via le menu de partage.");
      }
    });

    // Événement appinstalled : l'application vient d'être installée
    window.addEventListener('appinstalled', () => {
      console.log('Application installée.');
      localStorage.setItem('pwaInstalled', 'true');
      popup.classList.remove('show');
    });

    // Mise à jour en temps réel grâce à la media query (si supporté)
    if (window.matchMedia('(display-mode: standalone)').addEventListener) {
      const mql = window.matchMedia('(display-mode: standalone)');
      mql.addEventListener('change', (e) => {
        updatePopupBasedOnDisplayMode();
      });
    } else {
      // Sinon, on vérifie périodiquement (toutes les 2 secondes)
      setInterval(updatePopupBasedOnDisplayMode, 2000);
    }

    // Vérification initiale lors du chargement
    updatePopupBasedOnDisplayMode();
  </script>

</body>
</html>
